name: Deploy To EC2

on:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-ec2-main
  cancel-in-progress: true

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  DEPLOY_BUCKET: ${{ secrets.DEPLOY_BUCKET }}
  EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload build artifacts to S3
        run: |
          set -euo pipefail
          aws s3 sync .next "s3://${DEPLOY_BUCKET}/ui-update/.next" --delete --exclude 'cache/*'
          aws s3 sync app "s3://${DEPLOY_BUCKET}/ui-update/app" --delete
          aws s3 sync lib "s3://${DEPLOY_BUCKET}/ui-update/lib" --delete
          aws s3 sync styles "s3://${DEPLOY_BUCKET}/ui-update/styles" --delete
          aws s3 sync visualizer "s3://${DEPLOY_BUCKET}/ui-update/visualizer" --delete
          aws s3 cp package.json "s3://${DEPLOY_BUCKET}/ui-update/package.json"
          aws s3 cp pnpm-lock.yaml "s3://${DEPLOY_BUCKET}/ui-update/pnpm-lock.yaml"
          aws s3 sync prisma "s3://${DEPLOY_BUCKET}/ui-update/prisma" --delete
          aws s3 sync agent-service "s3://${DEPLOY_BUCKET}/ui-update/agent-service" --delete --exclude ".env" --exclude "node_modules/*"
          printf '%s\n' "${GITHUB_SHA}" | aws s3 cp - "s3://${DEPLOY_BUCKET}/ui-update/DEPLOYED_GIT_SHA"

      - name: Trigger EC2 deploy via SSM
        id: ssm
        run: |
          set -euo pipefail
          PARAMS=$(jq -nc --arg b "${DEPLOY_BUCKET}" '[
            "set -e",
            "cd /opt/bristlecone-app",
            "mv .next .next.bak.$(date +%s) || true",
            "mkdir -p .next",
            ("aws s3 sync s3://" + $b + "/ui-update/.next ./.next --delete --exclude \"cache/*\" --exact-timestamps"),
            ("aws s3 sync s3://" + $b + "/ui-update/app ./app --delete --exact-timestamps"),
            ("aws s3 sync s3://" + $b + "/ui-update/lib ./lib --delete --exact-timestamps"),
            ("aws s3 sync s3://" + $b + "/ui-update/styles ./styles --delete --exact-timestamps"),
            ("aws s3 sync s3://" + $b + "/ui-update/visualizer ./visualizer --delete --exact-timestamps"),
            ("aws s3 cp s3://" + $b + "/ui-update/package.json ./package.json"),
            ("aws s3 cp s3://" + $b + "/ui-update/pnpm-lock.yaml ./pnpm-lock.yaml"),
            ("aws s3 sync s3://" + $b + "/ui-update/prisma ./prisma --delete --exact-timestamps"),
            ("aws s3 sync s3://" + $b + "/ui-update/agent-service ./agent-service --delete --exact-timestamps --exclude \".env\" --exclude \"node_modules/*\""),
            "corepack pnpm install --frozen-lockfile",
            "export DATABASE_URL=${DATABASE_URL:-file:./prisma/.runtime/interviewbot.db}",
            "mkdir -p ./prisma/.runtime",
            "corepack pnpm prisma:generate",
            "corepack pnpm prisma:push",
            "npm --prefix /opt/bristlecone-app/agent-service install --omit=dev",
            "sudo systemctl restart bristlecone-agent.service",
            "sudo systemctl is-active bristlecone-agent.service",
            "sudo systemctl restart bristlecone-app.service",
            "sleep 2",
            "sudo systemctl is-active bristlecone-app.service",
            "cat .next/BUILD_ID"
          ]')
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${EC2_INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --query "Command.CommandId" \
            --output text \
            --parameters "commands=${PARAMS}")
          echo "command_id=${COMMAND_ID}" >> "$GITHUB_OUTPUT"
          aws ssm wait command-executed --command-id "${COMMAND_ID}" --instance-id "${EC2_INSTANCE_ID}"

      - name: Print SSM output
        if: always()
        run: |
          aws ssm get-command-invocation \
            --command-id "${{ steps.ssm.outputs.command_id }}" \
            --instance-id "${EC2_INSTANCE_ID}" \
            --query '{Status:Status,StdOut:StandardOutputContent,StdErr:StandardErrorContent}' \
            --output json
